<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fahrschul-App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Fahrschule">
    <meta name="theme-color" content="#1E40AF">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        .touch-button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .touch-button:active {
            transform: scale(0.95);
        }
        
        .student-card {
            transition: transform 0.2s ease;
        }
        
        .student-card:active {
            transform: scale(0.98);
        }
        
        /* Hide scrollbar but allow scrolling */
        .scroll-hidden::-webkit-scrollbar {
            display: none;
        }
        .scroll-hidden {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">📚 Deutsche Fahrschul-App</h1>
            <p class="text-gray-600 mt-2">Offline-Version für iPad</p>
        </header>
        
        <!-- Main Content -->
        <div id="main-content">
            <!-- Student List wird hier eingefügt -->
        </div>
    </div>
    
    <!-- Scripts -->
    <script>
        // Deutsche Datumsformatierung
        function formatGermanDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // LocalStorage Management
        const STORAGE_KEYS = {
            STUDENTS: 'fahrschul_students',
            SETTINGS: 'fahrschul_settings'
        };
        
        // Student Storage
        const studentsStorage = {
            getAll: () => {
                const stored = localStorage.getItem(STORAGE_KEYS.STUDENTS);
                return stored ? JSON.parse(stored) : [];
            },
            
            getById: (id) => {
                const students = studentsStorage.getAll();
                return students.find(s => s.id === id);
            },
            
            save: (student) => {
                const students = studentsStorage.getAll();
                const existingIndex = students.findIndex(s => s.id === student.id);
                
                if (existingIndex >= 0) {
                    students[existingIndex] = { ...student, updated_at: new Date().toISOString() };
                } else {
                    const newStudent = {
                        ...student,
                        id: student.id || Math.random().toString(36).substr(2, 9),
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    students.push(newStudent);
                }
                
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
                return students;
            }
        };
        
        // Demo-Daten erstellen
        function createDemoData() {
            const demoStudents = [
                {
                    id: 'anna-schmidt-001',
                    name: 'Anna',
                    surname: 'Schmidt',
                    date_of_birth: '1998-03-20',
                    address: 'Musterstraße 123, 12345 Berlin',
                    phone: '+49 123 456789',
                    start_date: '2024-01-15',
                    theory_exam_date: '2025-10-15',
                    practical_exam_date: '2025-11-20',
                    theory_exam_passed: false,
                    practical_exam_passed: false,
                    wears_glasses: true,
                    ueberlandfahrten: [true, true, false, true, false],
                    autobahnfahrten: [true, false, true, false, true],
                    nachtfahrten: [false, true, false],
                    uebungsfahrten_ganz: [true, true, false, true, false, false, true, false, true, true],
                    uebungsfahrten_halb: [true, false, true, false, true]
                }
            ];
            
            if (studentsStorage.getAll().length === 0) {
                demoStudents.forEach(student => studentsStorage.save(student));
            }
        }
        
        // Progress Berechnung
        function calculateOverallProgress(student) {
            const fahrten = [
                ...(student.ueberlandfahrten || []),
                ...(student.autobahnfahrten || []),
                ...(student.nachtfahrten || []),
                ...(student.uebungsfahrten_ganz || []),
                ...(student.uebungsfahrten_halb || [])
            ];
            
            const completed = fahrten.filter(Boolean).length;
            const total = fahrten.length;
            
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }
        
        function getProgressColor(percentage) {
            if (percentage >= 90) return 'text-green-500';
            if (percentage >= 70) return 'text-yellow-500';
            if (percentage >= 40) return 'text-orange-500';
            return 'text-red-500';
        }
        
        // Student List rendern
        function renderStudentList() {
            const students = studentsStorage.getAll();
            
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Fahrschüler</h2>
                    <button onclick="addNewStudent()" class="touch-button bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <span class="text-xl">+</span>
                        Neuer Schüler
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            `;
            
            students.forEach(student => {
                const progress = calculateOverallProgress(student);
                const colorClass = getProgressColor(progress);
                
                html += `
                    <div class="student-card bg-white rounded-xl shadow-sm p-6 cursor-pointer touch-button" onclick="openStudentDetail('${student.id}')">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">👤</div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">${student.name} ${student.surname}</h3>
                                    <p class="text-sm text-gray-600">Seit ${formatGermanDate(student.start_date)}</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold ${colorClass}">${progress}%</div>
                                <div class="text-xs text-gray-500">Fortschritt</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            ${student.date_of_birth ? `<div class="flex items-center gap-2">📅 Geb.: ${formatGermanDate(student.date_of_birth)}</div>` : ''}
                            ${student.phone ? `<div class="flex items-center gap-2">📞 ${student.phone}</div>` : ''}
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 text-center">
                            <div class="bg-gray-50 rounded-lg p-2">
                                <div class="text-sm font-semibold text-gray-800">${(student.uebungsfahrten_ganz || []).filter(Boolean).length}</div>
                                <div class="text-xs text-gray-600">Ganze h</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-2">
                                <div class="text-sm font-semibold text-gray-800">${(student.uebungsfahrten_halb || []).filter(Boolean).length}</div>
                                <div class="text-xs text-gray-600">Halbe h</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-2">
                                <div class="text-sm font-semibold text-gray-800">${(student.ueberlandfahrten || []).filter(Boolean).length}</div>
                                <div class="text-xs text-gray-600">Überland</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-2">
                                <div class="text-sm font-semibold text-gray-800">${(student.autobahnfahrten || []).filter(Boolean).length}</div>
                                <div class="text-xs text-gray-600">Autobahn</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            if (students.length === 0) {
                html = `
                    <div class="text-center py-16">
                        <div class="text-6xl mb-4">👤</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Noch keine Fahrschüler</h3>
                        <p class="text-gray-500 mb-6">Fügen Sie Ihren ersten Fahrschüler hinzu, um zu beginnen.</p>
                        <button onclick="addNewStudent()" class="touch-button bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            Ersten Schüler hinzufügen
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('main-content').innerHTML = html;
        }
        
        // Student Detail rendern
        function renderStudentDetail(studentId) {
            const student = studentsStorage.getById(studentId);
            if (!student) {
                renderStudentList();
                return;
            }
            
            let html = `
                <div class="space-y-6">
                    <div class="flex items-center gap-4 mb-6">
                        <button onclick="renderStudentList()" class="touch-button p-3 rounded-full hover:bg-gray-100 transition-colors">
                            ←
                        </button>
                        <div class="flex-1">
                            <h1 class="text-2xl font-bold text-gray-800">${student.name} ${student.surname}</h1>
                            <p class="text-gray-600">Fahrschüler-Details</p>
                        </div>
                    </div>
                    
                    <!-- Personal Data -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            👤 Persönliche Daten
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                            ${student.date_of_birth ? `<div class="flex items-center gap-2">📅 Geburtsdatum: ${formatGermanDate(student.date_of_birth)}</div>` : ''}
                            ${student.phone ? `<div class="flex items-center gap-2">📞 Telefon: ${student.phone}</div>` : ''}
                            ${student.address ? `<div class="flex items-center gap-2 md:col-span-2">📍 Adresse: ${student.address}</div>` : ''}
                            <div class="flex items-center gap-2">📅 Ausbildungsbeginn: ${formatGermanDate(student.start_date)}</div>
                            ${student.theory_exam_date ? `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${student.theory_exam_passed ? 'bg-green-500' : 'bg-yellow-500'}"></div> Theorieprüfung: ${student.theory_exam_passed ? 'Bestanden' : 'Geplant'} (${formatGermanDate(student.theory_exam_date)})</div>` : ''}
                            ${student.practical_exam_date ? `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${student.practical_exam_passed ? 'bg-green-500' : 'bg-yellow-500'}"></div> Praktische Prüfung: ${student.practical_exam_passed ? 'Bestanden' : 'Geplant'} (${formatGermanDate(student.practical_exam_date)})</div>` : ''}
                            ${student.wears_glasses !== null ? `<div class="flex items-center gap-2">👓 Brillenträger: ${student.wears_glasses ? 'Ja' : 'Nein'}</div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Practice Hours -->
                    <div class="space-y-6">
                        <h2 class="text-2xl font-bold text-gray-800">Geleistete Fahrten</h2>
                        ${renderFahrtenSection(student, 'Ganze Übungsstunden (1h)', 'uebungsfahrten_ganz', 'blue', true)}
                        ${renderFahrtenSection(student, 'Halbe Übungsstunden (0,5h)', 'uebungsfahrten_halb', 'green', true)}
                        ${renderFahrtenSection(student, 'Überlandfahrten', 'ueberlandfahrten', 'yellow', false)}
                        ${renderFahrtenSection(student, 'Autobahnfahrten', 'autobahnfahrten', 'orange', false)}
                        ${renderFahrtenSection(student, 'Nachtfahrten', 'nachtfahrten', 'purple', false)}
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
        }
        
        // Fahrten Section rendern
        function renderFahrtenSection(student, title, category, color, canAddRemove) {
            const fahrten = student[category] || [];
            const completed = fahrten.filter(Boolean).length;
            const total = fahrten.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            let html = `
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                            🕐 ${title}
                        </h3>
                        <div class="px-3 py-1 bg-${color}-100 text-${color}-800 rounded-full text-sm font-medium">
                            ${percentage}% (${completed}/${total})
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 items-center">
            `;
            
            fahrten.forEach((completed, index) => {
                html += `
                    <div class="relative group">
                        <button onclick="toggleFahrt('${student.id}', '${category}', ${index})" 
                                class="touch-button w-12 h-12 rounded-full flex items-center justify-center text-sm font-medium transition-all hover:scale-105 ${
                                    completed 
                                        ? 'bg-green-500 text-white hover:bg-green-600' 
                                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                }">
                            ${index + 1}
                        </button>
                        ${canAddRemove && fahrten.length > 1 ? `
                            <button onclick="removeFahrt('${student.id}', '${category}', ${index})" 
                                    class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center touch-button">
                                ×
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            if (canAddRemove) {
                html += `
                    <button onclick="addFahrt('${student.id}', '${category}')" 
                            class="touch-button w-12 h-12 rounded-full bg-${color}-500 text-white hover:bg-${color}-600 transition-all hover:scale-105 flex items-center justify-center font-bold text-lg">
                        +
                    </button>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Event Handlers
        function openStudentDetail(studentId) {
            renderStudentDetail(studentId);
        }
        
        function toggleFahrt(studentId, category, index) {
            const student = studentsStorage.getById(studentId);
            if (!student) return;
            
            const updatedFahrten = [...student[category]];
            updatedFahrten[index] = !updatedFahrten[index];
            
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            studentsStorage.save(updatedStudent);
            renderStudentDetail(studentId);
        }
        
        function addFahrt(studentId, category) {
            const student = studentsStorage.getById(studentId);
            if (!student) return;
            
            const updatedFahrten = [...(student[category] || []), false];
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            studentsStorage.save(updatedStudent);
            renderStudentDetail(studentId);
        }
        
        function removeFahrt(studentId, category, index) {
            const student = studentsStorage.getById(studentId);
            if (!student || (student[category] || []).length <= 1) return;
            
            const updatedFahrten = student[category].filter((_, i) => i !== index);
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            studentsStorage.save(updatedStudent);
            renderStudentDetail(studentId);
        }
        
        function addNewStudent() {
            alert('Neue Schüler hinzufügen - Feature kommt bald!');
        }
        
        // App starten
        document.addEventListener('DOMContentLoaded', function() {
            createDemoData();
            renderStudentList();
        });
        
        // Service Worker registrieren (für PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>