<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Deutsche Fahrschul-App</title>
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Fahrschule">
    <meta name="theme-color" content="#1E40AF">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        .touch-button {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .touch-button:active {
            transform: scale(0.95);
        }
        
        .student-card {
            transition: transform 0.2s ease;
        }
        
        .student-card:active {
            transform: scale(0.98);
        }
        
        /* Smooth animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Progress bars */
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        /* Training section colors */
        .grundstufe { background: linear-gradient(135deg, #FEF3C7, #F59E0B); }
        .aufbaustufe { background: linear-gradient(135deg, #FED7AA, #F97316); }
        .leistungsstufe { background: linear-gradient(135deg, #FCA5A5, #EF4444); }
        .situative_bausteine { background: linear-gradient(135deg, #BFDBFE, #60A5FA); }
        .fahrerassistenzsysteme { background: linear-gradient(135deg, #BFDBFE, #60A5FA); }
        .reife_teststufe { background: linear-gradient(135deg, #A7F3D0, #10B981); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Fahrschul-App wird geladen...</p>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <!-- Content wird hier eingefügt -->
        </div>
    </div>
    
    <script>
        // ==================== DATA MODELS ====================
        
        // Demo-Daten (Original aus der Preview)
        const DEMO_STUDENTS = [
            {
                id: 'anna-schmidt-001',
                name: 'Anna',
                surname: 'Schmidt',
                date_of_birth: '1998-03-20',
                address: 'Musterstraße 123, 12345 Berlin',
                phone: '+49 123 456789',
                start_date: '2024-01-15',
                theory_exam_date: '2025-10-15',
                practical_exam_date: '2025-11-20',
                theory_exam_passed: false,
                practical_exam_passed: false,
                wears_glasses: true,
                ueberlandfahrten: [true, true, false, true, false],
                autobahnfahrten: [true, false, true, false, true],
                nachtfahrten: [false, true, false],
                uebungsfahrten_ganz: [true, true, false, true, false, false, true, false, true, true],
                uebungsfahrten_halb: [true, false, true, false, true],
                created_at: '2024-01-15T10:00:00Z',
                updated_at: new Date().toISOString()
            },
            {
                id: 'daniel-daft-002',
                name: 'Daniel',
                surname: 'Daft',
                date_of_birth: '1995-07-12',
                address: 'Beispielweg 456, 54321 Hamburg',
                phone: '+49 987 654321',
                start_date: '2024-02-01',
                theory_exam_date: '2025-09-20',
                practical_exam_date: '2025-10-25',
                theory_exam_passed: true,
                practical_exam_passed: false,
                wears_glasses: false,
                ueberlandfahrten: [true, false, true, false, true],
                autobahnfahrten: [false, true, true, false],
                nachtfahrten: [true, false, true],
                uebungsfahrten_ganz: [true, true, true, false, true, false, true],
                uebungsfahrten_halb: [false, true, true, false],
                created_at: '2024-02-01T09:30:00Z',
                updated_at: new Date().toISOString()
            },
            {
                id: 'test-schueler-003',
                name: 'Test',
                surname: 'Schüler',
                date_of_birth: '2000-12-05',
                address: 'Teststraße 789, 98765 München',
                phone: '+49 555 123456',
                start_date: '2024-03-10',
                theory_exam_passed: false,
                practical_exam_passed: false,
                wears_glasses: null,
                ueberlandfahrten: [false, false, false, false, false],
                autobahnfahrten: [false, false, false, false],
                nachtfahrten: [false, false, false],
                uebungsfahrten_ganz: [true, false, false],
                uebungsfahrten_halb: [false, true],
                created_at: '2024-03-10T14:15:00Z',
                updated_at: new Date().toISOString()
            }
        ];

        // Training Categories (VOLLSTÄNDIG aus Backend - 1:1 Copy)
        const TRAINING_CATEGORIES = {
            "grundstufe": {
                "name": "Grundstufe",
                "subtitle": "Einweisung und Bedienung",
                "color": "#F59E0B",
                "sections": {
                    "besonderheiten_einsteigen": {
                        "name": "Besonderheiten beim Einsteigen",
                        "items": ["Besonderheiten beim Einsteigen"]
                    },
                    "einstellen": {
                        "name": "Einstellen", 
                        "items": ["Sitz", "Spiegel", "Lenkrad", "Kopfstütze"]
                    },
                    "lenkradhaltung": {
                        "name": "Lenkradhaltung",
                        "items": ["Lenkradhaltung"]
                    },
                    "pedale": {
                        "name": "Pedale",
                        "items": ["Pedale"]
                    },
                    "gurt_anlegen": {
                        "name": "Gurt anlegen/anpassen",
                        "items": ["Gurt anlegen/anpassen"]
                    },
                    "schalt_wahlhebel": {
                        "name": "Schalt-/Wählhebel",
                        "items": ["Schalt-/Wählhebel"]
                    },
                    "zundschloss": {
                        "name": "Zündschloss",
                        "items": ["Zündschloss"]
                    },
                    "motor_anlassen": {
                        "name": "Motor anlassen",
                        "items": ["Motor anlassen"]
                    },
                    "anfahren": {
                        "name": "Anfahren/Anhalteübungen",
                        "items": ["Anfahren/Anhalteübungen"]
                    },
                    "schaltubungen": {
                        "name": "Schaltübungen (umweltschonend)",
                        "items": ["hoch: 1-2", "2-3", "3-4", "...", "runter: 4-3", "3-2", "2-1", "...", "runter: 4-2", "4-1", "3-1"]
                    },
                    "lenkubungen": {
                        "name": "Lenkübungen",
                        "items": ["Lenkübungen"]
                    }
                }
            },
            "aufbaustufe": {
                "name": "Aufbaustufe", 
                "subtitle": "Umweltschonendes, vorausschauendes Fahren, Blickschulung",
                "color": "#F97316",
                "sections": {
                    "rollen_schalten": {
                        "name": "Rollen und Schalten",
                        "items": ["Rollen und Schalten"]
                    },
                    "abbremsen_schalten": {
                        "name": "Abbremsen und Schalten",
                        "items": ["Abbremsen und Schalten"]
                    },
                    "bremsübungen": {
                        "name": "Bremsübungen",
                        "items": ["degressiv", "Zielbremsungen", "Gefahrsituationen"]
                    },
                    "gefalle": {
                        "name": "Gefälle",
                        "items": ["Anhalten", "Anfahren", "Rückwärts", "Sichern", "Schalten"]
                    },
                    "steigung": {
                        "name": "Steigung", 
                        "items": ["Anhalten", "Anfahren", "Rückwärts", "Sichern", "Schalten"]
                    },
                    "tastgeschwindigkeit": {
                        "name": "Tastgeschwindigkeit",
                        "items": ["Tastgeschwindigkeit"]
                    },
                    "bedienungs_kontrolleinrichtungen": {
                        "name": "Bedienungs- und Kontrolleinrichtungen",
                        "items": ["Bedienungs- und Kontrolleinrichtungen"]
                    },
                    "ortliche_besonderheiten": {
                        "name": "Örtliche Besonderheiten",
                        "items": ["Örtliche Besonderheiten"]
                    }
                }
            },
            "leistungsstufe": {
                "name": "Leistungsstufe",
                "subtitle": "Schwierige Verkehrssituationen, umweltschonendes, vorausschauendes Fahren, Blickschulung/Bremsbereitschaft",
                "color": "#EF4444", 
                "sections": {
                    "fahrbahnabutzung": {
                        "name": "Fahrbahnbenutzung",
                        "items": ["Einordnen", "Markierungen"]
                    },
                    "fahrstreifenwechsel": {
                        "name": "Fahrstreifenwechsel",
                        "items": ["links", "rechts"]
                    },
                    "vorbeifahren": {
                        "name": "Vorbeifahren/Überholen",
                        "items": ["Vorbeifahren/Überholen"]
                    },
                    "abbiegen": {
                        "name": "Abbiegen",
                        "items": ["rechts", "links", "mehrspurig", "Radweg", "Sonderstreifen", "Straßenbahnen", "Einbahnstraßen"]
                    },
                    "vorfahrt": {
                        "name": "Vorfahrt",
                        "items": ["rechts vor links", "Grünpfeil", "Polizeibeamte", "Grünpfeil-Schild"]
                    },
                    "geschwindigkeit_abstand": {
                        "name": "Geschwindigkeit/Abstand",
                        "items": ["Geschwindigkeit/Abstand"]
                    },
                    "situationen_verkehrsteilnehmer": {
                        "name": "Situationen mit anderen Verkehrsteilnehmern",
                        "items": ["Fußgängerüberwege", "Kinder", "Öffentl. Verkehrsmittel", "Schulbus", "Ältere/Behinderte", "Radfahrer/Mofa", "Einbahnstr./Radfahrer", "Verk.-beruh. Bereich"]
                    },
                    "schwierige_verkehrsfuhrung": {
                        "name": "Schwierige Verkehrsführung",
                        "items": ["Schwierige Verkehrsführung"]
                    },
                    "engpass": {
                        "name": "Engpass",
                        "items": ["Engpass"]
                    },
                    "kreisverkehr": {
                        "name": "Kreisverkehr",
                        "items": ["Kreisverkehr"]
                    },
                    "bahnubergang": {
                        "name": "Bahnübergang (warten)",
                        "items": ["Bahnübergang (warten)"]
                    },
                    "kritische_verkehrssituationen": {
                        "name": "Kritische Verkehrssituationen",
                        "items": ["Hauptverkehrszeiten", "Partnerschaftliches Verhalten (Kommunikation, Verzicht auf Vorfahrt)", "Schwung nutzen"]
                    },
                    "fussganger_schutzbereich": {
                        "name": "Fußgänger Schutzbereich",
                        "items": ["Fußgänger Schutzbereich"]
                    }
                }
            },
            "grundfahraufgaben": {
                "name": "Grundfahraufgaben",
                "color": "#F59E0B",
                "sections": {
                    "ruckwartsfahren": {
                        "name": "Rückwärtsfahren",
                        "items": ["Rückwärtsfahren"]
                    },
                    "umkehren": {
                        "name": "Umkehren", 
                        "items": ["Umkehren"]
                    },
                    "gefahrbremsung": {
                        "name": "Gefahrbremsung",
                        "items": ["Gefahrbremsung"]
                    },
                    "einparken_langs": {
                        "name": "Einparken längs",
                        "items": ["vorwärts rechts", "vorwärts links", "rückwärts rechts", "rückwärts links"]
                    },
                    "einparken_quer": {
                        "name": "Einparken quer", 
                        "items": ["vorwärts rechts", "vorwärts links", "rückwärts rechts", "rückwärts links"]
                    }
                }
            },
            "uberlandfahrten": {
                "name": "Überlandfahrten",
                "subtitle": "Sicheres und umweltschonendes Fahren mit höheren Geschwindigkeiten auf Landstraßen",
                "color": "#FDE047",
                "sections": {
                    "main_items": {
                        "name": "",
                        "items": [
                            "Angepasste Geschwindigkeit/Gangwahl (alle Gänge)"
                        ]
                    },
                    "abstand": {
                        "name": "Abstand",
                        "items": ["vorne", "hinten", "seitlich"]
                    },
                    "main_items_2": {
                        "name": "",
                        "items": [
                            "Beobachtung/Spiegel",
                            "Verkehrszeichen",
                            "Kreuzungen/Einmündungen", 
                            "Kurven",
                            "Steigungen",
                            "Gefälle",
                            "Alleen",
                            "Überholen"
                        ]
                    },
                    "besondere_situationen": {
                        "name": "Besondere Situationen",
                        "items": ["Liegenbleiben • Absichern", "Einfahren in Ortschaften", "Fußgänger", "Wild/Tiere"]
                    },
                    "besondere_anforderungen": {
                        "name": "Besondere Anforderungen",
                        "items": ["Leistungsgrenze", "Ablenkung", "Konfliktsituationen"]
                    }
                }
            },
            "autobahn": {
                "name": "Autobahn",
                "subtitle": "Sicheres und umweltschonendes Fahren mit höheren Geschwindigkeiten auf Autobahnen",
                "color": "#FDE047",
                "sections": {
                    "main_items_1": {
                        "name": "",
                        "items": [
                            "Fahrtplanung",
                            "Einfahren in BAB",
                            "Fahrstreifenwahl", 
                            "Geschwindigkeit"
                        ]
                    },
                    "abstand": {
                        "name": "Abstand",
                        "items": ["vorne", "hinten", "seitlich"]
                    },
                    "main_items_2": {
                        "name": "",
                        "items": [
                            "Überholen",
                            "Schilder/Markierungen",
                            "Vorbeifahren/Anschlussstellen",
                            "Rast-/Parkplätze, Tankstellen",
                            "Verhalten bei Unfällen",
                            "Dichter Verkehr/Stau",
                            "Besondere Situationen"
                        ]
                    },
                    "besondere_anforderungen": {
                        "name": "Besondere Anforderungen",
                        "items": ["Leistungsgrenze", "Ablenkung", "Konfliktsituationen"]
                    },
                    "final_items": {
                        "name": "",
                        "items": ["Verlassen der BAB"]
                    }
                }
            },
            "dammerung_dunkelheit": {
                "name": "Dämmerung/Dunkelheit", 
                "subtitle": "Kontrollieren/Einschalten der Beleuchtungseinrichtungen",
                "color": "#FDE047",
                "sections": {
                    "beleuchtung": {
                        "name": "Beleuchtung",
                        "items": ["Kontrolle", "Benutzung", "Einstellen", "Fernlicht"]
                    },
                    "main_items": {
                        "name": "",
                        "items": [
                            "Beleuchtete Straßen",
                            "Unbeleuchtete Straßen", 
                            "Parken"
                        ]
                    },
                    "besondere_situationen": {
                        "name": "Besondere Situationen",
                        "items": ["Schlechte Witterung", "Bahnübergänge", "Tiere", "Unbeleuchtete Verkehrsteilnehmer"]
                    },
                    "besondere_anforderungen": {
                        "name": "Besondere Anforderungen",
                        "items": ["Blendung", "Orientierung"]
                    },
                    "final_items": {
                        "name": "",
                        "items": ["Abschlussbesprechung"]
                    }
                }
            },
            "reife_teststufe": {
                "name": "Reife- und Teststufe",
                "subtitle": "Abschluss der Ausbildung - Prüfungsvorbereitung",
                "color": "#10B981",
                "sections": {
                    "selbststandiges_fahren": {
                        "name": "Selbstständiges Fahren",
                        "items": ["innerorts", "außerorts"]
                    },
                    "verantwortungsbewusstes_fahren": {
                        "name": "Verantwortungsbewusstes Fahren",
                        "items": ["Verantwortungsbewusstes Fahren"]
                    },
                    "testfahrt": {
                        "name": "Testfahrt unter Prüfungsbedingungen",
                        "items": ["FAKT", "andere"]
                    },
                    "wiederholung": {
                        "name": "Wiederholung/Vertiefung",
                        "items": ["Wiederholung/Vertiefung"]
                    },
                    "leistungsbewertung": {
                        "name": "Leistungsbewertung", 
                        "items": ["Leistungsbewertung"]
                    }
                }
            },
            "situative_bausteine": {
                "name": "Situative Bausteine",
                "color": "#60A5FA",
                "sections": {
                    "fahrtechnische_vorbereitung": {
                        "name": "Checkliste zur fahrtechnischen Vorbereitung",
                        "sections": {
                            "fahrzeug": {
                                "name": "Beim Fahrzeug",
                                "items": ["Reifen (z.B. Beschädigungen, Profiltiefe, Reifendruck)"]
                            },
                            "scheiben_leuchten": {
                                "name": "Scheiben, Leuchten, Blinker, Hupe",
                                "items": ["Ein- und Ausschalten"]
                            },
                            "funktion_prufen": {
                                "name": "Funktion prüfen",
                                "items": ["Standlicht", "Abblendlicht", "Fernlicht", "Schlussleucht m. Kennzeichenbeleuchtung", "Nebelschlussleuchte", "Warnblinkanlage", "Blinker", "Hupe", "Bremsleuchte"]
                            },
                            "kontrollleuchten": {
                                "name": "Kontrollleuchten benennen",
                                "items": ["Kontrollleuchten benennen"]
                            },
                            "ruckstrahler": {
                                "name": "Rückstrahler",
                                "items": ["Vorhandensein", "Beschädigung"]
                            },
                            "lenkung": {
                                "name": "Lenkung",
                                "items": ["Lenkschloss entriegeln", "Überprüfen des Lenkspiels"]
                            },
                            "bremsen": {
                                "name": "Funktionsprüfung der Bremsen",
                                "items": ["Betriebsbremse", "Feststellbremse"]
                            }
                        }
                    }
                }
            },
            "fahrerassistenzsysteme": {
                "name": "Fahrerassistenzsysteme",
                "color": "#60A5FA",
                "sections": {
                    "bedienung": {
                        "name": "Bedienung der Fahrerassistenzsysteme",
                        "items": ["Bedienung der Fahrerassistenzsysteme"]
                    }
                }
            },
            "beim_fahrer": {
                "name": "Beim Fahrer (vor Fahrtbeginn)",
                "subtitle": "Richtige Sitzeinstellung",
                "color": "#60A5FA",
                "sections": {
                    "sitzeinstellung": {
                        "name": "Richtige Sitzeinstellung",
                        "items": ["Richtige Sitzeinstellung"]
                    },
                    "ruckspiegeleinstellung": {
                        "name": "Einstellung der Rückspiegel",
                        "items": ["der Kopfstütze", "des Lenkrades"]
                    },
                    "sicherheitsgurt": {
                        "name": "Anlegen des Sicherheitsgurtes",
                        "items": ["Anlegen des Sicherheitsgurtes"]
                    }
                }
            },
            "heizung_luftung": {
                "name": "Heizung und Lüftung",
                "color": "#60A5FA",
                "sections": {
                    "bedienen_aggregate": {
                        "name": "Bedienen der Aggregate",
                        "items": ["Heizung", "Lüftung", "Klimaanlage", "Heckscheibenheizung", "Beheizte Sonderausstattungen"]
                    },
                    "energiesparende_nutzung": {
                        "name": "Energiesparende Nutzung",
                        "items": ["keine unnötigen Verbraucher", "Rechtzeitiges Abschalten"]
                    }
                }
            },
            "betriebs_verkehrssicherheit": {
                "name": "Betriebs- und Verkehrssicherheit",
                "color": "#60A5FA",
                "sections": {
                    "motorraum": {
                        "name": "Motorraum/Flüssigkeitsstände",
                        "items": ["Motoröl", "Kühlmittel", "Scheibenwischflüssigkeit"]
                    },
                    "tanken": {
                        "name": "Tanken",
                        "items": ["Tanken"]
                    },
                    "sicherungsmittel": {
                        "name": "Sicherungsmittel",
                        "items": ["Warndreieck", "Verbandskasten", "Bordwerkzeug", "zusätzliche Ausrüstung"]
                    },
                    "aussenkontrolle": {
                        "name": "Außenkontrolle (Schäden, Sauberkeit)",
                        "items": ["Scheiben/Wischer", "Spiegel", "Kennzeichen(HU/AU)", "Beleuchtung"]
                    },
                    "bremsen": {
                        "name": "Bremsen",
                        "items": ["Bremsen"]
                    },
                    "ladung": {
                        "name": "Ladung",
                        "items": ["Sicherung", "Kennzeichnung"]
                    }
                }
            },
            "witterung": {
                "name": "Witterung",
                "subtitle": "Fahren bei verschiedenen Witterungsbedingungen",
                "color": "#60A5FA",
                "sections": {
                    "schlechte_witterung": {
                        "name": "Fahren bei schlechter Witterung",
                        "items": ["Lüftung", "Beleuchtung", "Scheibenwischer/-wascher", "Regen, Sprühnebel", "Wasserlachen, Aquaplaning", "Wind, Sturm, Böen", "Schnee und Matsch", "Eis"]
                    }
                }
            }
        };

        // ==================== STORAGE MANAGER ====================
        
        const STORAGE_KEYS = {
            STUDENTS: 'fahrschul_students',
            PROGRESS: 'fahrschul_progress',
            SETTINGS: 'fahrschul_settings'
        };

        const StorageManager = {
            // Students
            getStudents: () => {
                const stored = localStorage.getItem(STORAGE_KEYS.STUDENTS);
                return stored ? JSON.parse(stored) : [];
            },
            
            saveStudents: (students) => {
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
            },
            
            getStudentById: (id) => {
                const students = StorageManager.getStudents();
                return students.find(s => s.id === id);
            },
            
            updateStudent: (updatedStudent) => {
                const students = StorageManager.getStudents();
                const index = students.findIndex(s => s.id === updatedStudent.id);
                if (index >= 0) {
                    students[index] = { ...updatedStudent, updated_at: new Date().toISOString() };
                    StorageManager.saveStudents(students);
                    return students[index];
                }
                return null;
            },
            
            // Progress
            getProgress: () => {
                const stored = localStorage.getItem(STORAGE_KEYS.PROGRESS);
                return stored ? JSON.parse(stored) : [];
            },
            
            saveProgress: (progress) => {
                localStorage.setItem(STORAGE_KEYS.PROGRESS, JSON.stringify(progress));
            },
            
            // Initialize with demo data
            initDemoData: () => {
                if (StorageManager.getStudents().length === 0) {
                    StorageManager.saveStudents(DEMO_STUDENTS);
                }
            }
        };

        // ==================== UTILITY FUNCTIONS ====================
        
        // Deutsche Datumsformatierung
        function formatGermanDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Progress Berechnung
        function calculateOverallProgress(student) {
            const fahrten = [
                ...(student.ueberlandfahrten || []),
                ...(student.autobahnfahrten || []),
                ...(student.nachtfahrten || []),
                ...(student.uebungsfahrten_ganz || []),
                ...(student.uebungsfahrten_halb || [])
            ];
            
            const completed = fahrten.filter(Boolean).length;
            const total = fahrten.length;
            
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }

        function getProgressColor(percentage) {
            if (percentage >= 90) return 'text-green-500';
            if (percentage >= 70) return 'text-yellow-500';
            if (percentage >= 40) return 'text-orange-500';
            return 'text-red-500';
        }

        // ==================== MAIN APPLICATION ====================
        
        let currentView = 'list'; // 'list', 'detail'
        let selectedStudent = null;

        // Student List rendern
        function renderStudentList() {
            const students = StorageManager.getStudents();
            
            let html = `
                <div class="p-4 fade-in">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6 bg-white rounded-lg shadow-sm p-4">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">📚 Deutsche Fahrschul-App</h1>
                            <p class="text-gray-600">iOS Offline-Version</p>
                        </div>
                        <button onclick="showAlert('Neuer Schüler - Feature kommt bald!')" class="touch-button bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            + Neu
                        </button>
                    </div>

                    <!-- Student Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;
            
            students.forEach(student => {
                const progress = calculateOverallProgress(student);
                const colorClass = getProgressColor(progress);
                
                html += `
                    <div class="student-card bg-white rounded-xl shadow-sm p-4 cursor-pointer touch-button" onclick="openStudentDetail('${student.id}')">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                    👤
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${student.name} ${student.surname}</h3>
                                    <p class="text-sm text-gray-600">Seit ${formatGermanDate(student.start_date)}</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl font-bold ${colorClass}">${progress}%</div>
                                <div class="text-xs text-gray-500">Fortschritt</div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                            <div class="progress-bar ${progress >= 90 ? 'bg-green-500' : progress >= 70 ? 'bg-yellow-500' : progress >= 40 ? 'bg-orange-500' : 'bg-red-500'} h-2 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="grid grid-cols-4 gap-2 text-center text-xs">
                            <div class="bg-gray-50 rounded p-2">
                                <div class="font-semibold text-gray-800">${(student.uebungsfahrten_ganz || []).filter(Boolean).length}</div>
                                <div class="text-gray-600">Ganze h</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <div class="font-semibold text-gray-800">${(student.uebungsfahrten_halb || []).filter(Boolean).length}</div>
                                <div class="text-gray-600">Halbe h</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <div class="font-semibold text-gray-800">${(student.ueberlandfahrten || []).filter(Boolean).length}</div>
                                <div class="text-gray-600">Überland</div>
                            </div>
                            <div class="bg-gray-50 rounded p-2">
                                <div class="font-semibold text-gray-800">${(student.autobahnfahrten || []).filter(Boolean).length}</div>
                                <div class="text-gray-600">Autobahn</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            currentView = 'list';
        }

        // Student Detail rendern
        function renderStudentDetail(studentId) {
            const student = StorageManager.getStudentById(studentId);
            if (!student) {
                renderStudentList();
                return;
            }
            
            selectedStudent = student;
            
            let html = `
                <div class="p-4 fade-in">
                    <!-- Header -->
                    <div class="flex items-center gap-4 mb-6 bg-white rounded-lg shadow-sm p-4">
                        <button onclick="renderStudentList()" class="touch-button p-2 rounded-full hover:bg-gray-100 transition-colors">
                            ←
                        </button>
                        <div class="flex-1">
                            <h1 class="text-xl font-bold text-gray-800">${student.name} ${student.surname}</h1>
                            <p class="text-gray-600">Fahrschüler-Details</p>
                        </div>
                        <button onclick="showAlert('Bearbeiten - Feature kommt bald!')" class="touch-button p-2 rounded-full hover:bg-gray-100 transition-colors text-gray-600">
                            ✏️
                        </button>
                    </div>

                    <!-- Personal Data -->
                    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            👤 Persönliche Daten
                        </h2>
                        <div class="grid grid-cols-1 gap-3 text-sm text-gray-600">
                            ${student.date_of_birth ? `<div class="flex items-center gap-2">📅 Geburtsdatum: ${formatGermanDate(student.date_of_birth)}</div>` : ''}
                            ${student.phone ? `<div class="flex items-center gap-2">📞 Telefon: ${student.phone}</div>` : ''}
                            ${student.address ? `<div class="flex items-center gap-2">📍 Adresse: ${student.address}</div>` : ''}
                            <div class="flex items-center gap-2">📅 Ausbildungsbeginn: ${formatGermanDate(student.start_date)}</div>
                            ${student.theory_exam_date ? `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${student.theory_exam_passed ? 'bg-green-500' : 'bg-yellow-500'}"></div> Theorieprüfung: ${student.theory_exam_passed ? 'Bestanden' : 'Geplant'} (${formatGermanDate(student.theory_exam_date)})</div>` : ''}
                            ${student.practical_exam_date ? `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${student.practical_exam_passed ? 'bg-green-500' : 'bg-yellow-500'}"></div> Praktische Prüfung: ${student.practical_exam_passed ? 'Bestanden' : 'Geplant'} (${formatGermanDate(student.practical_exam_date)})</div>` : ''}
                            ${student.wears_glasses !== null ? `<div class="flex items-center gap-2">👓 Brillenträger: ${student.wears_glasses ? 'Ja' : 'Nein'}</div>` : ''}
                        </div>
                    </div>

                    ${renderFahrtenSection(student)}
                    ${renderTrainingProgress(student)}
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = html;
            currentView = 'detail';
        }

        // Fahrten Section rendern
        function renderFahrtenSection(student) {
            return `
                <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">🚗 Geleistete Fahrten</h2>
                    
                    ${renderFahrtType(student, 'Überlandfahrten (5 Fahrten)', 'ueberlandfahrten', '#FDE047', false)}
                    ${renderFahrtType(student, 'Autobahnfahrten (4 Fahrten)', 'autobahnfahrten', '#F97316', false)}
                    ${renderFahrtType(student, 'Nachtfahrten (3 Fahrten)', 'nachtfahrten', '#6366F1', false)}
                    ${renderFahrtType(student, 'Ganze Übungsstunden', 'uebungsfahrten_ganz', '#3B82F6', true)}
                    ${renderFahrtType(student, 'Halbe Übungsstunden', 'uebungsfahrten_halb', '#10B981', true)}
                </div>
            `;
        }

        // Einzelner Fahrt-Typ rendern
        function renderFahrtType(student, title, category, color, canAddRemove) {
            const fahrten = student[category] || [];
            const completed = fahrten.filter(Boolean).length;
            const total = fahrten.length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            let html = `
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-medium text-gray-700">${title}</h3>
                        <div class="px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${color}20; color: ${color};">
                            ${percentage}% (${completed}/${total})
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
            `;
            
            fahrten.forEach((completed, index) => {
                html += `
                    <div class="relative group">
                        <button onclick="toggleFahrt('${student.id}', '${category}', ${index})" 
                                class="touch-button w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all hover:scale-105 ${
                                    completed 
                                        ? 'bg-green-500 text-white hover:bg-green-600' 
                                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                }">
                            ${index + 1}
                        </button>
                        ${canAddRemove && fahrten.length > 1 ? `
                            <button onclick="removeFahrt('${student.id}', '${category}', ${index})" 
                                    class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center touch-button">
                                ×
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            if (canAddRemove) {
                html += `
                    <button onclick="addFahrt('${student.id}', '${category}')" 
                            class="touch-button w-10 h-10 rounded-full text-white hover:scale-105 transition-all flex items-center justify-center font-bold text-lg"
                            style="background-color: ${color};">
                        +
                    </button>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        // Training Progress rendern
        function renderTrainingProgress(student) {
            let html = `
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">📋 Ausbildungsfortschritt</h2>
            `;
            
            Object.entries(TRAINING_CATEGORIES).forEach(([key, category]) => {
                // Fahrerassistenzsysteme aus Situative Bausteine herausfiltern
                if (key === 'situative_bausteine') {
                    html += renderTrainingCategory(key, category, student, false);
                    // Fahrerassistenzsysteme als separate Kategorie
                    const fahrerassistenz = TRAINING_CATEGORIES.fahrerassistenzsysteme;
                    html += renderTrainingCategory('fahrerassistenzsysteme', fahrerassistenz, student, true);
                } else if (key !== 'fahrerassistenzsysteme') {
                    html += renderTrainingCategory(key, category, student, key === 'grundstufe');
                }
            });
            
            html += `</div>`;
            return html;
        }

        // Training Category rendern (mit verschachtelten Sections)
        function renderTrainingCategory(key, category, student, expanded) {
            const totalItems = countTotalItems(category.sections);
            const completedItems = Math.floor(totalItems * Math.random() * 0.3); // Demo-Progress
            const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            return `
                <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
                    <div class="p-4 ${key} text-white cursor-pointer touch-button" onclick="toggleTrainingSection('${key}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-semibold">${category.name}</h3>
                                ${category.subtitle ? `<p class="text-sm opacity-90">${category.subtitle}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold">${percentage}%</div>
                                <div class="text-xs opacity-90">${completedItems}/${totalItems}</div>
                            </div>
                        </div>
                        <div class="mt-2 bg-white bg-opacity-20 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    
                    <div id="section-${key}" class="overflow-hidden transition-all duration-300" style="max-height: ${expanded ? '2000px' : '0'};">
                        <div class="p-4 space-y-3">
                            ${Object.entries(category.sections).map(([sectionKey, section]) => 
                                renderSection(section, sectionKey, 0)
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Section rendern (rekursiv für verschachtelte Strukturen)
        function renderSection(section, sectionKey, level = 0) {
            if (section.sections) {
                // Hat verschachtelte Sections
                return `
                    <div class="${level > 0 ? 'ml-4 border-l-2 border-gray-200 pl-4' : 'border-l-4 border-gray-200 pl-3'} mb-4">
                        ${section.name ? `<h4 class="font-medium text-gray-700 mb-2 ${level === 0 ? 'text-base' : 'text-sm'}">${section.name}</h4>` : ''}
                        <div class="space-y-3">
                            ${Object.entries(section.sections).map(([subKey, subSection]) => 
                                renderSection(subSection, `${sectionKey}_${subKey}`, level + 1)
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                // Hat direkte Items
                return `
                    <div class="${level > 0 ? 'ml-4' : 'border-l-4 border-gray-200 pl-3'} mb-3">
                        ${section.name ? `<h4 class="font-medium text-gray-700 mb-2 ${level === 0 ? 'text-base' : 'text-sm'}">${section.name}</h4>` : ''}
                        <div class="space-y-1">
                            ${section.items ? section.items.map(item => `
                                <div class="flex items-center gap-2 text-sm">
                                    <div class="w-4 h-4 border border-gray-300 rounded flex items-center justify-center text-xs cursor-pointer hover:bg-gray-100" onclick="toggleProgressItem(this)">
                                        ${Math.random() > 0.7 ? '✓' : ''}
                                    </div>
                                    <span class="text-gray-600">${item}</span>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>
                `;
            }
        }

        // Gesamtanzahl Items rekursiv zählen
        function countTotalItems(sections) {
            let total = 0;
            Object.values(sections).forEach(section => {
                if (section.sections) {
                    total += countTotalItems(section.sections);
                } else if (section.items) {
                    total += section.items.length;
                }
            });
            return total;
        }

        // Progress Item togglen
        function toggleProgressItem(element) {
            if (element.textContent.trim() === '✓') {
                element.textContent = '';
                element.classList.remove('bg-green-100', 'text-green-600');
            } else {
                element.textContent = '✓';
                element.classList.add('bg-green-100', 'text-green-600');
            }
        }

        // ==================== EVENT HANDLERS ====================
        
        function openStudentDetail(studentId) {
            renderStudentDetail(studentId);
        }

        function toggleFahrt(studentId, category, index) {
            const student = StorageManager.getStudentById(studentId);
            if (!student) return;
            
            const updatedFahrten = [...student[category]];
            updatedFahrten[index] = !updatedFahrten[index];
            
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            StorageManager.updateStudent(updatedStudent);
            renderStudentDetail(studentId);
        }

        function addFahrt(studentId, category) {
            const student = StorageManager.getStudentById(studentId);
            if (!student) return;
            
            const updatedFahrten = [...(student[category] || []), false];
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            StorageManager.updateStudent(updatedStudent);
            renderStudentDetail(studentId);
        }

        function removeFahrt(studentId, category, index) {
            const student = StorageManager.getStudentById(studentId);
            if (!student || (student[category] || []).length <= 1) return;
            
            const updatedFahrten = student[category].filter((_, i) => i !== index);
            const updatedStudent = {
                ...student,
                [category]: updatedFahrten
            };
            
            StorageManager.updateStudent(updatedStudent);
            renderStudentDetail(studentId);
        }

        function toggleTrainingSection(sectionId) {
            const section = document.getElementById(`section-${sectionId}`);
            const isExpanded = section.style.maxHeight !== '0px';
            section.style.maxHeight = isExpanded ? '0px' : '1000px';
        }

        function showAlert(message) {
            alert(message);
        }

        // ==================== APP INITIALIZATION ====================
        
        function initApp() {
            // Demo-Daten initialisieren
            StorageManager.initDemoData();
            
            // Loading Screen ausblenden
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Student List anzeigen
            renderStudentList();
        }

        // Service Worker für PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('data:text/javascript,console.log("SW registered")')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // App starten
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>